
# Workflow name - appears in GitHub Actions UI
name: Build and Deploy .NET Web App

on:
  push:
    branches:
      - '**'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ✅ IMPORTANT: Debug FIRST (otherwise we never see it)
      - name: Debug - list folders
        run: |
          echo "PWD:"
          pwd
          echo "Top level:"
          ls -la
          echo "AzureWorkshopApp folder?"
          ls -la AzureWorkshopApp || true
          echo "Find package.json:"
          find . -maxdepth 6 -name package.json -print || true
          echo "Find csproj:"
          find . -maxdepth 8 -name "*.csproj" -print || true

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      # ✅ Avoid hard fail if folder is missing - gives clear message
      - name: Install npm packages
        shell: bash
        run: |
          if [ -d "AzureWorkshopApp" ]; then
            cd AzureWorkshopApp
            if [ -f "package.json" ]; then
              npm install
            else
              echo "No package.json inside AzureWorkshopApp - skipping npm install"
            fi
          else
            echo "Directory AzureWorkshopApp does not exist in runner checkout!"
            echo "This usually means the folder is not committed/pushed to GitHub."
            exit 1
          fi

      - name: Restore dependencies
        run: dotnet restore ./AzureWorkshopApp/AzureWorkshopApp.csproj

      - name: Build
        run: dotnet build ./AzureWorkshopApp/AzureWorkshopApp.csproj --configuration Release --no-restore

      - name: Publish
        run: dotnet publish ./AzureWorkshopApp/AzureWorkshopApp.csproj --configuration Release --output ./publish --no-build

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: dotnet-app
          path: ./publish